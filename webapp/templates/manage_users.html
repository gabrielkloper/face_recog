{% extends "layout.html" %}
{% block content %}
    <h2>Manage Users</h2>
    <p>Administrators can add, edit, and delete users from this page.</p>

    <h3>Add New User</h3>
    <form method="POST" action="{{ url_for('main.add_user') }}">
        {{ form.hidden_tag() }} <!-- CSRF token -->
        <div>
            {{ form.username.label }}<br>
            {{ form.username(size=30) }}<br>
            {% for error in form.username.errors %}
            <span style="color: red;">[{{ error }}]</span><br>
            {% endfor %}
        </div>
        <br>
        <div>
            {{ form.password.label }}<br>
            {{ form.password(size=30) }}<br>
            {% for error in form.password.errors %}
            <span style="color: red;">[{{ error }}]</span><br>
            {% endfor %}
        </div>
        <br>
        <div>
            {{ form.confirm_password.label }}<br>
            {{ form.confirm_password(size=30) }}<br>
            {% for error in form.confirm_password.errors %}
            <span style="color: red;">[{{ error }}]</span><br>
            {% endfor %}
        </div>
        <br>
        <div>
            {{ form.is_admin() }} {{ form.is_admin.label }}
        </div>
        <br>
        <div>
            {{ form.submit() }}
        </div>
    </form>
    <hr>

    <h3>Existing Users</h3>
    {% if users %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Is Admin</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user_item in users %} {# Changed loop variable to avoid conflict with current_user #}
            <tr>
                <td>{{ user_item.id }}</td>
                <td>{{ user_item.username }}</td>
                <td>{{ 'Yes' if user_item.is_admin else 'No' }}</td>
                <td class="action-links">
                    <a href="{{ url_for('main.edit_user', user_id=user_item.id) }}">Edit</a>
                    {% if user_item.id != current_user.id %} {# Prevent deleting self #}
                    <form method="POST" action="{{ url_for('main.delete_user', user_id=user_item.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> <!-- Manual CSRF for non-FlaskForm POST -->
                        <input type="submit" value="Delete" style="background:none; border:none; color:red; cursor:pointer; text-decoration:underline;">
                    </form>
                    {% else %}
                    (Current User)
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No users found.</p>
    {% endif %}
{% endblock %}
